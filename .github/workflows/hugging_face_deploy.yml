# .github/workflows/deploy-hf-space.yml
name: Deploy to Hugging Face Space (Docker, hardcoded creds)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # âš ï¸ Hardcoded creds (rotate later; prefer GH Secrets)
      - name: Define HF credentials and target
        run: |
          echo "HF_TOKEN=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" >> $GITHUB_ENV
          echo "HF_USERNAME=AliNiazi1" >> $GITHUB_ENV
          echo "SPACE_NAME=Nasa-space-apps" >> $GITHUB_ENV

      # Minimal README front-matter so the Space is recognized as Docker and uses port 7860
      - name: Add README front-matter for Docker Space (temp)
        run: |
          cat > README.md <<'EOF'
          ---
          title: Space Biology API
          emoji: ðŸ›°ï¸
          colorFrom: indigo
          colorTo: pink
          sdk: docker
          app_port: 7860
          pinned: false
          ---
          FastAPI backend deployed as a Docker Space.
          EOF

      # Dockerfile: install deps, copy app, run FastAPI on 7860
      - name: Add Dockerfile (temp)
        run: |
          cat > Dockerfile <<'EOF'
          FROM python:3.11-slim
          RUN useradd -m user
          WORKDIR /app

          # Install dependencies first (backend/requirements.txt exists in your tree)
          COPY backend/requirements.txt /app/requirements.txt
          RUN pip install --no-cache-dir -r /app/requirements.txt

          # Copy project
          COPY . /app
          USER user

          # Spaces expect the app to listen on 7860 (or set app_port in README)
          EXPOSE 7860

          # Start FastAPI; --app-dir adds backend/ so "from routes ..." works
          CMD ["uvicorn", "--app-dir", "backend", "main:app", "--host", "0.0.0.0", "--port", "7860"]
          EOF

      # Install HF CLI + Git LFS (LFS is required for files >10MB)
      - name: Install huggingface_hub CLI and Git LFS
        run: |
          python -m pip install --upgrade pip
          pip install "huggingface_hub[cli]"
          sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install

      # âœ… Non-interactive login: pass the token as a flag and store it as a Git credential
      - name: Hugging Face login (Git credential)
        env:
          HF_TOKEN: ${{ env.HF_TOKEN }}
        run: |
          huggingface-cli login --token "${HF_TOKEN}" --add-to-git-credential

      # Push to the Space repo (triggers Space build)
      - name: Push to Hugging Face Space
        env:
          HF_USERNAME: ${{ env.HF_USERNAME }}
          SPACE_NAME: ${{ env.SPACE_NAME }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote remove space 2>/dev/null || true
          git remote add space "https://huggingface.co/spaces/${HF_USERNAME}/${SPACE_NAME}.git"
          git push space HEAD:main --force
