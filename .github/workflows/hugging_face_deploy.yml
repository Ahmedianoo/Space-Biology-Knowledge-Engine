# .github/workflows/deploy-hf-space.yml
name: Deploy to Hugging Face Space (Docker, hardcoded creds)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- Hardcoded creds (âš ï¸ unsafe; prefer GH Secrets) ---
      - name: Define HF credentials and target
        run: |
          echo "HF_TOKEN=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" >> $GITHUB_ENV
          echo "HF_USERNAME=AliNiazi1" >> $GITHUB_ENV
          echo "SPACE_NAME=Nasa-space-apps" >> $GITHUB_ENV

      - name: Add README front-matter
        run: |
          cat > README.md <<'EOF'
          ---
          title: Space Biology API
          emoji: ðŸ›°ï¸
          colorFrom: indigo
          colorTo: pink
          sdk: docker
          app_port: 7860
          pinned: false
          ---
          FastAPI backend deployed as a Docker Space.
          EOF

      - name: Add Dockerfile
        run: |
          cat > Dockerfile <<'EOF'
          FROM python:3.11-slim
          RUN useradd -m user
          WORKDIR /app
          COPY backend/requirements.txt /app/requirements.txt
          RUN pip install --no-cache-dir -r /app/requirements.txt
          COPY . /app
          USER user
          EXPOSE 7860
          CMD ["uvicorn", "--app-dir", "backend", "main:app", "--host", "0.0.0.0", "--port", "7860"]
          EOF

      # Install Git LFS (Spaces uses LFS for files >10MB)
      - name: Install Git LFS
        run: |
          sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install

      # Push to the Space repo (use PAT in URL so Git won't prompt)
      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ env.HF_TOKEN }}
          HF_USERNAME: ${{ env.HF_USERNAME }}
          SPACE_NAME: ${{ env.SPACE_NAME }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote remove space 2>/dev/null || true
          # Embed <username>:<token> in the remote URL (officially supported)
          git remote add space "https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${SPACE_NAME}.git"

          git push space HEAD:main --force
