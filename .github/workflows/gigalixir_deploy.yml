name: Deploy FastAPI to Gigalixir (no extra files)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Fail fast if any required secret is missing/blank
      - name: Validate required secrets
        run: |
          for v in GIGALIXIR_EMAIL GIGALIXIR_API_KEY GIGALIXIR_APP; do
            if [ -z "${!v}" ] || [ "${!v}" = "null" ]; then
              echo "Missing or empty secret: $v" >&2
              exit 1
            fi
          done
        env:
          GIGALIXIR_EMAIL: ${{ secrets.GIGALIXIR_EMAIL }}
          GIGALIXIR_API_KEY: ${{ secrets.GIGALIXIR_API_KEY }}
          GIGALIXIR_APP: ${{ secrets.GIGALIXIR_APP }}

      # Temp Procfile so you don't commit one
      - name: Create Procfile (temp)
        run: echo 'web: uvicorn main:app --host=0.0.0.0 --port=$PORT' > Procfile
      - name: Temp commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Procfile
          git commit -m "ci: temp Procfile for Gigalixir deploy" || true

      # Store credentials in a local file and pre-approve them for Git
      - name: Configure Git credential helper
        run: git config --global credential.helper "store --file .git-credentials"

      - name: Approve credentials for HTTPS pushes
        run: |
          # Approve for both path patterns to be safe
          for p in "${GIGALIXIR_APP}.git" "${GIGALIXIR_APP}"; do
            printf "protocol=https\nhost=git.gigalixir.com\npath=%s\nusername=%s\npassword=%s\n\n" \
              "$p" "$GIGALIXIR_EMAIL" "$GIGALIXIR_API_KEY" | git credential approve
          done
        env:
          GIGALIXIR_EMAIL: ${{ secrets.GIGALIXIR_EMAIL }}
          GIGALIXIR_API_KEY: ${{ secrets.GIGALIXIR_API_KEY }}
          GIGALIXIR_APP: ${{ secrets.GIGALIXIR_APP }}

      - name: Add Gigalixir remote
        run: |
          git remote remove gigalixir 2>/dev/null || true
          git remote add gigalixir "https://git.gigalixir.com/${GIGALIXIR_APP}.git"
          git remote -v
        env:
          GIGALIXIR_APP: ${{ secrets.GIGALIXIR_APP }}

      - name: Push to Gigalixir (deploy) with branch fallback
        run: |
          set -e
          if git push gigalixir HEAD:main --force; then
            echo "Deployed to 'main'"
          elif git push gigalixir HEAD:master --force; then
            echo "Deployed to 'master'"
          else
            echo "Push failed to both 'main' and 'master'." >&2
            exit 1
          fi
