# .github/workflows/gigalixir-fastapi.yml
name: Deploy FastAPI to Gigalixir (hardcoded creds; no extra files)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ðŸ‘‰ Set your FastAPI import path here once
    #    Examples: "main:app" or "src.main:app" or "app.server:api"
    env:
      APP_IMPORT: backend.main:app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history so pushes arenâ€™t shallow

      # Pin Python (temp). If the stack doesn't support 3.13.1 yet, use 3.13 or 3.12.x.
      - name: Create .python-version (temp)
        shell: bash
        run: |
          printf '%s\n' '3.13.1' > .python-version

      - name: Use backend/requirements.txt for buildpack
        shell: bash
        run: |
          if [ -f backend/requirements.txt ]; then
            cp backend/requirements.txt ./requirements.txt
          else
            printf '%s\n' 'fastapi' 'uvicorn' > requirements.txt
          fi

      # Create Procfile using APP_IMPORT (temp)
      - name: Create Procfile (temp)
        shell: bash
        run: |
          # Use ${APP_IMPORT} here; escape $PORT so it stays literal for the dyno
          printf '%s\n' "web: uvicorn backend.main:app --host=0.0.0.0 --port=$PORT" > Procfile

      - name: Temp commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .python-version Procfile requirements.txt
          git commit -m "ci: temp py version / Procfile / requirements for Gigalixir deploy" || true

      # --- HARD-CODED VALUES (âš ï¸ security risk; prefer Actions Secrets) ---
      - name: Define credentials and app
        run: |
          echo "GIGALIXIR_EMAIL=aliniazi2005@gmail.com" >> $GITHUB_ENV
          echo "GIGALIXIR_API_KEY=233c11c5-fc86-43f3-b253-caacf0a53022" >> $GITHUB_ENV
          echo "GIGALIXIR_APP=nasa-space-apps" >> $GITHUB_ENV
      # -----------------------------------------

      # Configure a workspace-local credential store
      - name: Configure Git credential helper (workspace-local)
        run: git config --global credential.helper "store --file .git-credentials"

      # Pre-approve credentials so Git won't prompt
      - name: Approve credentials for Git
        run: |
          for p in "${GIGALIXIR_APP}.git" "${GIGALIXIR_APP}"; do
            printf "protocol=https\nhost=git.gigalixir.com\npath=%s\nusername=%s\npassword=%s\n\n" \
              "$p" "$GIGALIXIR_EMAIL" "$GIGALIXIR_API_KEY" | git credential approve
          done

      - name: Add Gigalixir remote
        run: |
          git remote remove gigalixir 2>/dev/null || true
          git remote add gigalixir "https://git.gigalixir.com/${GIGALIXIR_APP}.git"
          git remote -v

      - name: Push to Gigalixir (deploy) with branch fallback
        run: |
          set -e
          if git push gigalixir HEAD:main --force; then
            echo "Deployed to 'main'"
          elif git push gigalixir HEAD:master --force; then
            echo "Deployed to 'master'"
          else
            echo "Push failed to both 'main' and 'master'." >&2
            exit 1
          fi

